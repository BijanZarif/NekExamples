#!/bin/bash
# This script is designed to assist the compilation process of NEK5
#
###############################################################################
# User Settings
###############################################################################

# use MPI (true or false)
IFMPI=true

# Fortran compiler
F77=mpif77

# C compiler
CC=mpicc

# compiler Flags
G=  # '-Knoieee -Ktrap=fp'

# Absolute path of the NEK5 source 
SOURCE_ROOT=/home/$USER/nek5_svn/trunk/core

# linking libraries
USR_LIB=


###############################################################################



















###############################################################################
# What follows you don't have to touch
###############################################################################

# do some checks

if [ $# -eq 0 ]
then
  echo "missing argument!"
  echo "usage: makenek [.usr filename] [clean]"
  exit 1
fi

if [ ! -f $SOURCE_ROOT/makefile ]
then
  echo "$SOURCE_ROOT/makefile does not exist!"
  exit 1
fi

if [ $# -eq 1 ]
then
  if [ $1 = "clean" ]
  then
    make -f $SOURCE_ROOT/makefile clean
    exit 0
  fi
  
  if [ ! -f ${1}'.usr' ]
  then
     echo "$1.usr does not exist!"
     exit 1
  fi
fi

# check if the compiler adds an underscore to external functions

$CC -c $SOURCE_ROOT/byte.c 
nm byte.o | grep byte_write_
if [ $? -ne 0 ] 
then
  UNDERSCORE=" -DUNDERSCORE"
fi
rm byte.o

# publish enviroment variables

export F77
export CC
export G
export IFMPI
export UNDERSCORE
export SOURCE_ROOT
export USR
export USR_LIB


# compile nek5 using gmake

rm -f nek5000 2>/dev/null
rm -f $SOURCE_ROOT/SIZE
rm -f $SOURCE_ROOT/subuser.f 2>/dev/null

\mv ./obj/*.o . 2>/dev/null
ln -sf `pwd`/SIZEu    $SOURCE_ROOT/SIZE
ln -sf `pwd`/$1.usr   $SOURCE_ROOT/subuser.f

make -f $SOURCE_ROOT/makefile 2>&1 | tee compiler.out

rm -f $SOURCE_ROOT/SIZE 
rm -f $SOURCE_ROOT/subuser.f

mkdir obj 2>/dev/null
\mv *.o ./obj 2>/dev/null
echo
echo
echo 'Compiler output saved in compiler.out'
echo
echo
