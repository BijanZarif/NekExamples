C Linearized Model problem described in Ananias G. Tomboulides et. al
C JCP 146, CP986079, 1998
C
C Validation case for Low-Mach number implementation
C
C-----------------------------------------------------------------------
C
C  USER SPECIFIED ROUTINES: 
C
C     - boundary conditions 
C     - initial conditions  
C     - variable properties 
C     - forcing function for fluid (f)
C     - forcing function for passive scalar (q)
C     - general purpose routine for checking errors etc.        
C
c-----------------------------------------------------------------------
      SUBROUTINE USERVP (IX,IY,IZ,ieg)

C Set user variable properties

      INCLUDE 'SIZE'   
      INCLUDE 'TOTAL'  
      INCLUDE 'NEKUSE' 

      UDIFF = 1.
      UTRANS= 1./TEMP

      RETURN
      END

C=======================================================================

      SUBROUTINE USERF  (IX,IY,IZ,ieg)                

C Set user forcing function for the momentum

      INCLUDE 'SIZE'   
      INCLUDE 'TSTEP'  
      INCLUDE 'NEKUSE' 

      FFY = 0.0
      FFX = 0.0
      FFZ = 0.0

      RETURN
      END

C=======================================================================

      SUBROUTINE USERQ  (IX,IY,IZ,ieg)                

C Set user forcing function for the energy and species

      INCLUDE 'SIZE'   
      INCLUDE 'TOTAL'  
      INCLUDE 'NEKUSE' 

      real delta,sech,XD
      parameter(delta=0.2)

      XD = X/delta
      sech = 1.0/cosh(XD)
     
      qvol = sech*sech/delta * (0.5 + tanh(XD)/delta)

      RETURN
      END

C=======================================================================

      SUBROUTINE USERCHK

      INCLUDE 'SIZE'
      INCLUDE 'TOTAL'

      COMMON /SCRNS/ w1     (LX1,LY1,LZ1,LELT)
     $              ,T_err  (LX1,LY1,LZ1,LELT)
     $              ,VX_err (LX1,LY1,LZ1,LELT)
     $              ,QTL_err (LX1,LY1,LZ1,LELT)


      real sumqw

      real delta,l2_err,exact,max_err,XD,sech
      parameter(delta=0.2)

      ntot = nx1*ny1*nz1*nelv

      if(istep.lt.1) return

      do 100 iel=1,nelv
      do 100 k=1,nz1
      do 100 j=1,ny1
      do 100 i=1,nx1
         XD = XM1(i,j,k,iel)/delta
         sech = 1.0/cosh(XD)
         exact = 0.5*(3.0 + tanh(XD))
         VX_err(i,j,k,iel) = abs(VX (i,j,k,iel  ) - exact) 
         T_err(i,j,k,iel) = abs( T (i,j,k,iel,1) - exact) 
         QTL_err(i,j,k,iel) = abs(QTL(i,j,k,iel) - 
     &                            0.5/delta*(1. - (tanh(XD)*tanh(XD))))
 100  continue 
  
      call col3(w1,VX_err,VX_err,ntot)
      call col2(w1,BM1,ntot)
      l2_err  = GLSUM(w1,ntot)/VOLVM1
      max_err = GLMAX(VX_err,ntot)
      write(*,*) 'ERROR VX: MAX/L2', max_err, SQRT(l2_err)   

      call col3(w1,T_err,T_err,ntot)
      call col2(w1,BM1,ntot)
      l2_err = GLSUM(w1,ntot)/VOLVM1
      max_err = GLMAX(T_err,ntot)
      write(*,*) 'ERROR T: MAX/L2', max_err, SQRT(l2_err)   

      call col3(w1,QTL_err,QTL_err,ntot)
      l2_err = GLSUM(w1,ntot)/VOLVM1
      max_err = GLMAX(QTL_err,ntot)
      write(*,*) 'ERROR QTL: MAX/L2', max_err, SQRT(l2_err)   


      RETURN
      END

C=======================================================================

      SUBROUTINE USERBC (IX,IY,IZ,ISIDE,ieg)                

C  Set user boundary conditions

      INCLUDE 'SIZE'
      INCLUDE 'TSTEP'
      INCLUDE 'NEKUSE'

      REAL delta
      parameter(delta=0.2)

      XD = X/delta
 
      IF (IFIELD .eq. 1) THEN          ! velocity
     
            UX = 0.5*( 3.0 + tanh(XD) )
            UY = 0.0

      ELSEIF (IFIELD .eq. 2) THEN      ! Temperature

          TEMP = 0.5*( 3.0 + tanh(XD) )

      ENDIF

      return
      END   

C=======================================================================

      SUBROUTINE USERIC (IX,IY,IZ,ieg)

C   Set initial conditions

      INCLUDE 'SIZE'
      INCLUDE 'TSTEP'
      INCLUDE 'NEKUSE'

      real delta
      parameter(delta=0.2)

      XD = X/delta

      IF (IFIELD.EQ.1) THEN          ! ---------- Velocity
          UX = 0.5*(3.0 + tanh(XD))
          UY = 0.0
      ENDIF

      IF (IFIELD.EQ.2)               ! ---------- Temperature
     &    TEMP = 0.5*(3.0 + tanh(XD))

      RETURN
      END

C=======================================================================

      subroutine usrdat

      return
      end

C=======================================================================

      subroutine usrdat2

      return
      end

C=======================================================================
      subroutine usrdat3

      return
      end
C=======================================================================
